{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Synapse Configuration Schema v2",
  "description": "Schema for .synapse/config.json file structure",
  "type": "object",
  "required": [
    "synapse_version",
    "project",
    "workflows",
    "settings"
  ],
  "properties": {
    "synapse_version": {
      "type": "string",
      "description": "Version of Synapse configuration format"
    },
    "initialized_at": {
      "type": "string",
      "description": "ISO 8601 timestamp of initialization"
    },
    "agent": {
      "type": "object",
      "properties": {
        "type": {
          "type": ["string", "null"]
        },
        "description": {
          "type": ["string", "null"]
        }
      }
    },
    "project": {
      "type": "object",
      "required": ["name", "root_directory"],
      "properties": {
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "root_directory": {
          "type": "string"
        }
      }
    },
    "workflows": {
      "type": "object",
      "properties": {
        "active_workflow": {
          "type": ["string", "null"]
        },
        "applied_workflows": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "applied_at"],
            "properties": {
              "name": {
                "type": "string"
              },
              "applied_at": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "settings": {
      "type": "object",
      "properties": {
        "auto_backup": {
          "type": "boolean"
        },
        "strict_validation": {
          "type": "boolean"
        },
        "uv_required": {
          "type": "boolean"
        }
      }
    },
    "quality-config": {
      "type": "object",
      "description": "Quality gate configuration for hooks - supports single project or monorepo mode",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["single", "monorepo"],
          "description": "Configuration mode: 'single' for single project, 'monorepo' for multiple projects. Defaults to 'single' if not specified."
        },
        "projectType": {
          "type": "string",
          "description": "Type of project (python, node, rust, go, etc.) - used in single mode only"
        },
        "commands": {
          "type": "object",
          "description": "Quality check commands - used in single mode only",
          "properties": {
            "lint": {
              "type": "string",
              "description": "Command to run linting"
            },
            "typecheck": {
              "type": "string",
              "description": "Command to run type checking"
            },
            "test": {
              "type": "string",
              "description": "Command to run tests"
            },
            "coverage": {
              "type": "string",
              "description": "Command to run coverage analysis"
            },
            "build": {
              "type": "string",
              "description": "Command to build project"
            }
          },
          "additionalProperties": false
        },
        "thresholds": {
          "type": "object",
          "description": "Quality thresholds for validation - used in single mode only",
          "properties": {
            "coverage": {
              "type": "object",
              "description": "Coverage thresholds per metric",
              "properties": {
                "statements": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                },
                "branches": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                },
                "functions": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                },
                "lines": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                }
              }
            },
            "lintLevel": {
              "type": "string",
              "enum": ["strict", "flexible"],
              "description": "Lint strictness level"
            },
            "lintTimeout": {
              "type": "number",
              "description": "Timeout for lint command in seconds"
            },
            "typecheckTimeout": {
              "type": "number",
              "description": "Timeout for typecheck command in seconds"
            },
            "testTimeout": {
              "type": "number",
              "description": "Timeout for test command in seconds"
            },
            "buildTimeout": {
              "type": "number",
              "description": "Timeout for build command in seconds"
            }
          }
        },
        "metadata": {
          "type": "object",
          "description": "Metadata about config generation",
          "properties": {
            "generated": {
              "type": "string",
              "description": "Timestamp of generation"
            },
            "detectedFiles": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Files that influenced detection"
            }
          }
        },
        "optimization": {
          "type": "object",
          "description": "Performance optimization settings for monorepo quality checks",
          "properties": {
            "check_affected_only": {
              "type": "boolean",
              "default": true,
              "description": "Only check projects with detected changes (git-based detection)"
            },
            "detection_method": {
              "type": "string",
              "enum": ["uncommitted", "since_main", "last_commit", "staged", "all_changes"],
              "default": "uncommitted",
              "description": "Git detection method: uncommitted (default), since_main, last_commit, staged, or all_changes"
            },
            "fallback_to_all": {
              "type": "boolean",
              "default": true,
              "description": "Check all projects if no changes detected (safety fallback)"
            },
            "force_check_projects": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "default": [],
              "description": "Projects to always check regardless of changes (e.g., shared libraries)"
            },
            "verbose_logging": {
              "type": "boolean",
              "default": false,
              "description": "Show detailed detection information in hook output"
            }
          },
          "additionalProperties": false
        },
        "projects": {
          "type": "object",
          "description": "Project configurations for monorepo mode - each key is a project name",
          "patternProperties": {
            "^[a-zA-Z0-9_-]+$": {
              "type": "object",
              "required": ["directory", "commands", "thresholds"],
              "properties": {
                "directory": {
                  "type": "string",
                  "pattern": "^[^/].*/$",
                  "description": "Relative path to project directory (must end with /)"
                },
                "projectType": {
                  "type": "string",
                  "description": "Type of project (python, node, rust, go, etc.)"
                },
                "commands": {
                  "type": "object",
                  "description": "Quality check commands for this project",
                  "properties": {
                    "lint": {
                      "type": "string",
                      "description": "Command to run linting"
                    },
                    "typecheck": {
                      "type": "string",
                      "description": "Command to run type checking"
                    },
                    "test": {
                      "type": "string",
                      "description": "Command to run tests"
                    },
                    "coverage": {
                      "type": "string",
                      "description": "Command to run coverage analysis"
                    },
                    "build": {
                      "type": "string",
                      "description": "Command to build project"
                    }
                  },
                  "additionalProperties": false
                },
                "thresholds": {
                  "type": "object",
                  "description": "Quality thresholds for this project",
                  "properties": {
                    "coverage": {
                      "type": "object",
                      "description": "Coverage thresholds per metric",
                      "properties": {
                        "statements": {
                          "type": "number",
                          "minimum": 0,
                          "maximum": 100
                        },
                        "branches": {
                          "type": "number",
                          "minimum": 0,
                          "maximum": 100
                        },
                        "functions": {
                          "type": "number",
                          "minimum": 0,
                          "maximum": 100
                        },
                        "lines": {
                          "type": "number",
                          "minimum": 0,
                          "maximum": 100
                        }
                      }
                    },
                    "lintLevel": {
                      "type": "string",
                      "enum": ["strict", "flexible"],
                      "description": "Lint strictness level"
                    },
                    "lintTimeout": {
                      "type": "number",
                      "description": "Timeout for lint command in seconds"
                    },
                    "typecheckTimeout": {
                      "type": "number",
                      "description": "Timeout for typecheck command in seconds"
                    },
                    "testTimeout": {
                      "type": "number",
                      "description": "Timeout for test command in seconds"
                    },
                    "buildTimeout": {
                      "type": "number",
                      "description": "Timeout for build command in seconds"
                    }
                  }
                },
                "metadata": {
                  "type": "object",
                  "description": "Metadata about this project's config",
                  "properties": {
                    "generated": {
                      "type": "string",
                      "description": "Timestamp of generation"
                    },
                    "detectedFiles": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Files that influenced detection"
                    }
                  }
                }
              }
            }
          },
          "additionalProperties": false,
          "minProperties": 1
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "mode": {"const": "monorepo"}
            },
            "required": ["mode"]
          },
          "then": {
            "required": ["projects"],
            "not": {
              "anyOf": [
                {"required": ["commands"]},
                {"required": ["thresholds"]}
              ]
            },
            "errorMessage": "Monorepo mode requires 'projects' object and must not have top-level 'commands' or 'thresholds'"
          },
          "else": {
            "if": {
              "properties": {
                "mode": {"const": "single"}
              },
              "required": ["mode"]
            },
            "then": {
              "required": ["commands", "thresholds"],
              "not": {
                "required": ["projects"]
              },
              "errorMessage": "Single mode requires 'commands' and 'thresholds' and must not have 'projects'"
            },
            "else": {
              "required": ["commands", "thresholds"],
              "not": {
                "required": ["projects"]
              },
              "errorMessage": "When 'mode' is not specified (defaults to single), requires 'commands' and 'thresholds'"
            }
          }
        }
      ]
    },
    "third_party_workflow": {
      "type": "object",
      "description": "Third-party workflow configuration (BREAKING CHANGE: single workflow object, not array)",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["openspec", "spec-kit", "custom", "unknown"],
          "description": "Workflow type"
        },
        "detection_method": {
          "type": "string",
          "enum": ["known_pattern", "llm_analysis", "user_specified"],
          "description": "How this workflow was detected"
        },
        "root_directory": {
          "type": "string",
          "description": "Root directory of the workflow"
        },
        "active_feature_directory": {
          "type": "string",
          "description": "Directory for the currently active feature"
        },
        "active_tasks_file": {
          "type": "string",
          "description": "Path to task file relative to project root (required for QA verification)"
        },
        "active_tasks": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^T\\d{3,}$",
            "description": "Task code (e.g., T001, T002)"
          },
          "default": [],
          "description": "Task codes currently being worked on - agent must set when starting work and clear when complete"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Detection confidence score"
        },
        "detected_at": {
          "type": "string",
          "description": "ISO 8601 timestamp of detection"
        },
        "task_format_schema": {
          "type": "object",
          "description": "Task Format Schema v2.0 - defines how tasks are structured and parsed",
          "required": ["version", "patterns", "field_mapping", "status_semantics"],
          "properties": {
            "version": {
              "type": "string",
              "pattern": "^2\\.\\d+$",
              "description": "Schema version (2.x)"
            },
            "patterns": {
              "type": "object",
              "description": "Regex patterns for parsing task file",
              "required": ["task", "subtask"],
              "properties": {
                "task": {
                  "type": "string",
                  "description": "Regex pattern to match task lines (must have task_code capture group)"
                },
                "subtask": {
                  "type": "string",
                  "description": "Regex pattern to match subtask lines (must have subtask_code capture group)"
                },
                "status_field": {
                  "type": "string",
                  "description": "Regex pattern to match status field lines (must have field_code and status_value capture groups)"
                }
              }
            },
            "field_mapping": {
              "type": "object",
              "description": "Maps field types to their codes in the task file",
              "properties": {
                "dev_status": {
                  "type": "string",
                  "description": "Field code for Dev Status (e.g., 'DS')"
                },
                "qa": {
                  "type": "string",
                  "description": "Field code for QA Status (e.g., 'QA')"
                },
                "user_verification": {
                  "type": "string",
                  "description": "Field code for User Verification Status (e.g., 'UV')"
                }
              }
            },
            "status_semantics": {
              "type": "object",
              "description": "Semantic meaning of status values",
              "required": ["states"],
              "properties": {
                "states": {
                  "type": "object",
                  "description": "Status state definitions per field type",
                  "properties": {
                    "dev": {
                      "type": "object",
                      "description": "Dev Status semantic categories",
                      "properties": {
                        "not_started": {
                          "type": "array",
                          "items": {"type": "string"},
                          "description": "Status values meaning not started (e.g., ['Not Started'])"
                        },
                        "in_progress": {
                          "type": "array",
                          "items": {"type": "string"},
                          "description": "Status values meaning in progress (e.g., ['In Progress', 'Working'])"
                        },
                        "complete": {
                          "type": "array",
                          "items": {"type": "string"},
                          "description": "Status values meaning complete (e.g., ['Complete', 'Done'])"
                        }
                      }
                    },
                    "qa": {
                      "type": "object",
                      "description": "QA Status semantic categories (three categories: not verified, verified success, verified failure)",
                      "required": ["not_verified", "verified_success", "verified_failure_pattern"],
                      "properties": {
                        "not_verified": {
                          "type": "array",
                          "items": {"type": "string"},
                          "description": "Status values meaning not yet verified - hook BLOCKS (e.g., ['Not Started'])"
                        },
                        "verified_success": {
                          "type": "array",
                          "items": {"type": "string"},
                          "description": "Status values meaning verified successfully - hook ALLOWS (e.g., ['Complete', 'Passed'])"
                        },
                        "verified_failure_pattern": {
                          "type": "string",
                          "description": "Regex pattern for verified failures - hook ALLOWS (e.g., '^Failed - .*' matches 'Failed - lint errors line 45')"
                        }
                      }
                    },
                    "user_verification": {
                      "type": "object",
                      "description": "User Verification Status semantic categories",
                      "properties": {
                        "not_started": {
                          "type": "array",
                          "items": {"type": "string"},
                          "description": "Status values meaning not started"
                        },
                        "verified": {
                          "type": "array",
                          "items": {"type": "string"},
                          "description": "Status values meaning verified by user"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "required": ["type", "active_tasks_file", "task_format_schema"]
    }
  }
}
