{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Synapse Configuration Schema",
  "description": "Schema for .synapse/config.json file structure",
  "type": "object",
  "required": [
    "synapse_version",
    "project",
    "workflows",
    "settings"
  ],
  "properties": {
    "synapse_version": {
      "type": "string",
      "description": "Version of Synapse configuration format"
    },
    "initialized_at": {
      "type": "string",
      "description": "ISO 8601 timestamp of initialization"
    },
    "agent": {
      "type": "object",
      "properties": {
        "type": {
          "type": ["string", "null"]
        },
        "description": {
          "type": ["string", "null"]
        }
      }
    },
    "project": {
      "type": "object",
      "required": ["name", "root_directory"],
      "properties": {
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "root_directory": {
          "type": "string"
        }
      }
    },
    "workflows": {
      "type": "object",
      "properties": {
        "active_workflow": {
          "type": ["string", "null"]
        },
        "applied_workflows": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "applied_at"],
            "properties": {
              "name": {
                "type": "string"
              },
              "applied_at": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "settings": {
      "type": "object",
      "properties": {
        "auto_backup": {
          "type": "boolean"
        },
        "strict_validation": {
          "type": "boolean"
        },
        "uv_required": {
          "type": "boolean"
        }
      }
    },
    "quality-config": {
      "type": "object",
      "description": "Quality gate configuration for hooks",
      "required": ["commands", "thresholds"],
      "properties": {
        "projectType": {
          "type": "string",
          "description": "Type of project (python, node, rust, etc.)"
        },
        "commands": {
          "type": "object",
          "description": "Quality check commands - MUST be flat object, NOT subprojects",
          "properties": {
            "lint": {
              "type": "string",
              "description": "Command to run linting"
            },
            "typecheck": {
              "type": "string",
              "description": "Command to run type checking"
            },
            "test": {
              "type": "string",
              "description": "Command to run tests"
            },
            "coverage": {
              "type": "string",
              "description": "Command to run coverage analysis"
            },
            "build": {
              "type": "string",
              "description": "Command to build project"
            }
          },
          "additionalProperties": false
        },
        "thresholds": {
          "type": "object",
          "description": "Quality thresholds for validation",
          "properties": {
            "coverage": {
              "type": "object",
              "description": "Coverage thresholds per metric",
              "properties": {
                "statements": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                },
                "branches": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                },
                "functions": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                },
                "lines": {
                  "type": "number",
                  "minimum": 0,
                  "maximum": 100
                }
              }
            },
            "lintLevel": {
              "type": "string",
              "enum": ["strict", "flexible"],
              "description": "Lint strictness level"
            },
            "lintTimeout": {
              "type": "number",
              "description": "Timeout for lint command in seconds"
            },
            "typecheckTimeout": {
              "type": "number",
              "description": "Timeout for typecheck command in seconds"
            },
            "testTimeout": {
              "type": "number",
              "description": "Timeout for test command in seconds"
            },
            "buildTimeout": {
              "type": "number",
              "description": "Timeout for build command in seconds"
            }
          }
        },
        "metadata": {
          "type": "object",
          "description": "Metadata about config generation",
          "properties": {
            "generated": {
              "type": "string",
              "description": "Timestamp of generation"
            },
            "detectedFiles": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Files that influenced detection"
            }
          }
        }
      },
      "not": {
        "required": ["subprojects"]
      },
      "errorMessage": {
        "not": "Config uses 'subprojects' structure which is incompatible with current hooks. Expected flat 'commands' and 'thresholds' structure."
      }
    },
    "third_party_workflows": {
      "type": "object",
      "description": "Third-party workflow detection results",
      "properties": {
        "detected": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["openspec", "spec-kit", "custom", "unknown"]
              },
              "detection_method": {
                "type": "string",
                "enum": ["known_pattern", "llm_analysis", "user_specified"]
              },
              "root_directory": {
                "type": "string"
              },
              "active_feature_directory": {
                "type": "string"
              },
              "active_tasks_file": {
                "type": "string"
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "detected_at": {
                "type": "string"
              },
              "task_format_schema": {
                "type": "object",
                "description": "Task Format Schema v2.0"
              }
            }
          }
        },
        "user_preferences": {
          "type": "object",
          "properties": {
            "no_task_management": {
              "type": "boolean"
            },
            "custom_patterns": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "pattern": {
                    "type": "string"
                  },
                  "type": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "last_scan": {
          "type": "string",
          "description": "ISO 8601 timestamp of last scan"
        }
      }
    }
  }
}
